- route:
    from:
      uri: "mqtt-v3:camel/iot"
      parameters:
        broker: "tcp://test.mosquitto.org:1883"
      steps:
        - to: "log:from-mqtt"
        - choice:
            when:
              #
              # if from "sensor-1", extract data, make it uppercase, send to sensors/near
              #
              - jq: '.source == "sensor-1"'
                steps:
                - to: "log:sensor-1"
                - transform:
                    jq: '.data'
                - transform:
                    wasm: "quay.io/lburgazzoli/camel-go-wasm:latest?etc/wasm/fn/to_upper.wasm"
                - to: "dapr-pubsub:sensors/near"
                - to: "log:near"
              #
              # if from "sensor-2", extract data, make it lowercase, send to sensors/far
              #
              - jq: '.source == "sensor-2"'
                steps:
                  - to: "log:sensor-2"
                  - transform:
                      jq: '.data'
                  - transform:
                      wasm: "quay.io/lburgazzoli/camel-go-wasm:latest?etc/wasm/fn/to_lower.wasm"
                  - to: "dapr-pubsub:sensors/far"
                  - to: "log:far"
            otherwise:
              steps:
                - to: "log:unknown"
